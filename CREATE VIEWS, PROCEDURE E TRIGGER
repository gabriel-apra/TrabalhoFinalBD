CREATE VIEW VW_AVALIACOES_DENUNCIADAS AS
SELECT
    USREST.NOM_USR AS ESTUDANTE,
    AV.VAL_AVALIACAO AS AVALIACAO,
    AV.DES_AVALIACAO AS DESCRICAO,
    TR.NOM_DISCIPLINA AS DISCIPLINA,
    USRPROF.NOM_USR AS PROFESSOR,
    DP.NOM_DEPARTAMENTO AS DEPARTAMENTO,
    DN.PROCEDE as DENUNCIADO
FROM AVALIACOES AV
LEFT JOIN ESTUDANTES EST ON EST.IND_ESTUDANTE = AV.IND_ESTUDANTE
LEFT JOIN USUARIOS USREST ON USREST.CPF_USR = EST.CPF_ESTUDANTE
LEFT JOIN PROFESSORES PROF ON PROF.IND_PROFESSOR = AV.IND_PROFESSOR
LEFT JOIN USUARIOS USRPROF ON USRPROF.CPF_USR = PROF.CPF_PROFESSOR 
LEFT JOIN DEPARTAMENTOS DP ON AV.IND_DEPARTAMENTO = DP.IND_DEPARTAMENTO
LEFT JOIN DENUNCIAS DN ON DN.IND_AVALIACAO = AV.IND_AVALIACAO
LEFT JOIN TURMAS TR ON TR.IND_TURMA = AV.IND_TURMA
WHERE DN.PROCEDE = 1


CREATE TRIGGER TW_INATIVAR_DENUNCIADOS 
ON DENUNCIAS
FOR INSERT AS
BEGIN
    UPDATE AVALIACOES
    SET ATIVO = 0
    FROM DENUNCIAS
    WHERE AVALIACOES.IND_AVALIACAO = DENUNCIAS.IND_AVALIACAO
END


CREATE PROCEDURE SP_INATIVAR_TURMAS_PROFESSOR
@CPF INT OUTPUT, @IND_DEPARTAMENTO INT OUTPUT
AS
    UPDATE PROFESSORES SET ATIVO = 0 WHERE @CPF = CPF_PROFESSOR and @IND_DEPARTAMENTO = IND_DEPARTAMENTO AND ativo = 1
    UPDATE TURMAS  SET ATIVO = 0 WHERE IND_DEPARTAMENTO = @IND_DEPARTAMENTO AND IND_PROFESSOR = (SELECT IND_PROFESSOR FROM PROFESSORES WHERE CPF_PROFESSOR = @CPF AND IND_DEPARTAMENTO = @IND_DEPARTAMENTO) and ATIVO =1
GO

CREATE VIEW VW_TURMAS_PROFESSOR AS
SELECT 
USR.NOM_USR AS PROFESSOR,
PR.ATIVO AS PROFESSOR_ATIVO,
TR.COD_TURMA AS CODIGO_TURMA,
TR.ATIVO AS TURMA_ATIVA,
DP.NOM_DEPARTAMENTO AS NOME_DEPARTAMENTO,
DP.ATIVO AS DEPARTAMENTO_ATIVO

FROM TURMAS TR 
INNER JOIN PROFESSORES PR ON TR.IND_PROFESSOR = PR.IND_PROFESSOR
INNER JOIN USUARIOS USR ON USR.CPF_USR = PR.CPF_PROFESSOR
INNER JOIN DEPARTAMENTOS DP ON DP.IND_DEPARTAMENTO = TR.IND_DEPARTAMENTO
WHERE TR.ATIVO=1 AND PR.ATIVO = 1 AND TR.ATIVO=1
